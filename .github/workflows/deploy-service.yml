name: Deploy Service to ECS

on:
  repository_dispatch:
    types: [deploy-service]
  workflow_dispatch:
    inputs:
      service:
        description: "Service name (frontend, user-accounts, catalog, etc.)"
        required: true
      image_uri:
        description: "Full ECR image URI"
        required: true
      container_port:
        description: "Container port (80 for frontend, 8080 for backend)"
        required: false
        default: '8080'
      desired_count:
        description: "Desired task count"
        required: false
        default: '1'

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-southeast-1
      SERVICE: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.service || github.event.inputs.service }}
      IMAGE_URI: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.image_uri || github.event.inputs.image_uri }}
      CONTAINER_PORT: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.container_port || github.event.inputs.container_port || '8080' }}
      DESIRED_COUNT: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.desired_count || github.event.inputs.desired_count || '1' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform init
        working-directory: terraform-service-deploy
        run: terraform init -input=false -reconfigure

      - name: Set service-specific secrets
        id: secrets
        run: |
          case "$SERVICE" in
            frontend)
              echo "log_group=/ecs/ph-shoes-services-automation-frontend" >> $GITHUB_OUTPUT
              echo "exec_role=${{ secrets.FRONTEND_EXEC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "task_role=${{ secrets.FRONTEND_TASK_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "port=80" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "log_group=/ecs/ph-shoes-services-automation-$SERVICE" >> $GITHUB_OUTPUT
              echo "exec_role=${{ secrets.BACKEND_EXEC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "task_role=${{ secrets.BACKEND_TASK_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "port=${CONTAINER_PORT}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Deploy via Terraform
        working-directory: terraform-service-deploy
        env:
          TF_VAR_service_id: ${{ env.SERVICE }}
          TF_VAR_container_image: ${{ env.IMAGE_URI }}
          TF_VAR_container_port: ${{ steps.secrets.outputs.port }}
          TF_VAR_desired_count: ${{ env.DESIRED_COUNT }}
          TF_VAR_log_group_name: ${{ steps.secrets.outputs.log_group }}
          TF_VAR_execution_role_arn: ${{ steps.secrets.outputs.exec_role }}
          TF_VAR_task_role_arn: ${{ steps.secrets.outputs.task_role }}
        run: |
          echo "Deploying $SERVICE with image $IMAGE_URI on port $TF_VAR_container_port"
          terraform apply -input=false -auto-approve
