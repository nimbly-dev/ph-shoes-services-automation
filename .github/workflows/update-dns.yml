name: Update DNS Records

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force DNS update even if no changes detected'
        required: false
        type: boolean
        default: false
  schedule:
    # Run once daily at 2 AM UTC to update DNS records based on current service placement
    - cron: '0 2 * * *'

jobs:
  update-dns:
    name: Update Dynamic DNS Records
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-1
          role-session-name: dns-update-session
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Initialize Terraform
        working-directory: terraform-core
        run: terraform init
      
      - name: Capture current DNS state
        id: current-state
        working-directory: terraform-core
        run: |
          echo "Capturing current DNS configuration..."
          
          # Get current service-to-IP mappings
          if terraform output -json service_instance_ips > current_ips.json 2>/dev/null; then
            echo "current_ips=$(cat current_ips.json)" >> $GITHUB_OUTPUT
            echo "✓ Current IP mappings captured"
          else
            echo "current_ips={}" >> $GITHUB_OUTPUT
            echo "⚠ No current IP mappings found"
          fi
          
          # Get current DNS records
          if terraform output -json cloudflare_dns_records > current_dns.json 2>/dev/null; then
            echo "current_dns=$(cat current_dns.json)" >> $GITHUB_OUTPUT
            echo "✓ Current DNS records captured"
          else
            echo "current_dns={}" >> $GITHUB_OUTPUT
            echo "⚠ No current DNS records found"
          fi
      
      - name: Check cluster status
        id: cluster-status
        run: |
          echo "Checking ECS cluster status..."
          
          # Check if any instances are running
          instance_count=$(aws ec2 describe-instances \
            --filters "Name=tag:aws:autoscaling:groupName,Values=ph-shoes-services-ecs-asg" \
                      "Name=instance-state-name,Values=running" \
            --query 'length(Reservations[].Instances[])' \
            --output text)
          
          echo "Running instances: $instance_count"
          echo "instance_count=$instance_count" >> $GITHUB_OUTPUT
          
          if [ "$instance_count" -eq 0 ]; then
            echo "⚠ Cluster is scaled to zero - DNS will use maintenance mode"
            echo "cluster_status=scaled_to_zero" >> $GITHUB_OUTPUT
          else
            echo "✓ Cluster has running instances"
            echo "cluster_status=active" >> $GITHUB_OUTPUT
          fi
      
      - name: Refresh service discovery
        id: refresh
        working-directory: terraform-core
        run: |
          echo "Refreshing service discovery data..."
          echo "Cluster status: ${{ steps.cluster-status.outputs.cluster_status }}"
          
          # Refresh external data sources to get latest service placement
          terraform refresh -target=module.dynamic_dns
          
          echo "✓ Service discovery refreshed"
      
      - name: Plan DNS updates
        id: plan
        working-directory: terraform-core
        run: |
          echo "Planning DNS updates..."
          
          # Create plan for DNS updates
          terraform plan -out=dns-update.tfplan
          
          # Check if there are any changes
          if terraform show -json dns-update.tfplan | jq -e '.resource_changes | length > 0' > /dev/null; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "✓ DNS changes detected"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "- No DNS changes needed"
          fi
      
      - name: Apply DNS updates
        if: steps.plan.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        working-directory: terraform-core
        run: |
          echo "Applying DNS updates..."
          
          # Apply the planned changes
          terraform apply -auto-approve dns-update.tfplan
          
          echo "✓ DNS updates applied successfully"
      
      - name: Capture updated DNS state
        id: updated-state
        if: steps.plan.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        working-directory: terraform-core
        run: |
          echo "Capturing updated DNS configuration..."
          
          # Get updated service-to-IP mappings
          if terraform output -json service_instance_ips > updated_ips.json 2>/dev/null; then
            echo "updated_ips=$(cat updated_ips.json)" >> $GITHUB_OUTPUT
            echo "✓ Updated IP mappings captured"
          fi
          
          # Get updated DNS records
          if terraform output -json cloudflare_dns_records > updated_dns.json 2>/dev/null; then
            echo "updated_dns=$(cat updated_dns.json)" >> $GITHUB_OUTPUT
            echo "✓ Updated DNS records captured"
          fi
      
      - name: Validate DNS propagation
        if: steps.plan.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
        run: |
          echo "Validating DNS propagation..."
          
          # Wait for DNS propagation
          sleep 30
          
          # Test key domains
          domains=("phshoesproject.com" "catalog.phshoesproject.com" "alerts.phshoesproject.com" "accounts.phshoesproject.com")
          
          for domain in "${domains[@]}"; do
            echo "Testing DNS resolution for $domain..."
            
            if nslookup "$domain" > /dev/null 2>&1; then
              echo "✓ $domain resolves successfully"
            else
              echo "⚠ $domain resolution failed (may be propagating)"
            fi
          done
      
      - name: Generate summary report
        if: always()
        run: |
          echo "=== DNS Update Summary ==="
          echo "Timestamp: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          echo "Cluster Status: ${{ steps.cluster-status.outputs.cluster_status }}"
          echo "Running Instances: ${{ steps.cluster-status.outputs.instance_count }}"
          
          if [ "${{ steps.cluster-status.outputs.cluster_status }}" == "scaled_to_zero" ]; then
            echo "Status: ⚠ Cluster scaled to zero"
            echo "DNS Mode: Maintenance mode (all domains point to parking page)"
            echo "Action: DNS records updated to prevent resolution failures"
          elif [ "${{ steps.plan.outputs.changes_detected }}" == "true" ]; then
            echo "Status: ✓ DNS updates applied"
            echo "Changes: Service placement changes detected and DNS records updated"
          elif [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            echo "Status: ✓ Forced DNS refresh completed"
            echo "Changes: DNS refresh forced by manual trigger"
          else
            echo "Status: - No changes needed"
            echo "Changes: All services are optimally routed"
          fi
          
          echo ""
          echo "Next scheduled update: $(date -d '+1 day')"
      
      - name: Cleanup temporary files
        if: always()
        working-directory: terraform-core
        run: |
          rm -f dns-update.tfplan current_ips.json current_dns.json updated_ips.json updated_dns.json