name: Check Service Logs

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service name to check logs for"
        required: true
        type: choice
        options: ['frontend', 'catalog', 'user-accounts', 'text-search', 'alerts']
      lines:
        description: "Number of log lines to retrieve"
        required: false
        default: '50'

permissions:
  contents: read
  id-token: write

jobs:
  check-logs:
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: ap-southeast-1
      SERVICE: ${{ github.event.inputs.service }}
      LINES: ${{ github.event.inputs.lines }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECS service status
        run: |
          echo "üîç Checking ECS service status for $SERVICE..."
          aws ecs describe-services \
            --cluster ph-shoes-services-ecs \
            --services ph-shoes-services-automation-$SERVICE \
            --region $AWS_REGION \
            --query 'services[0].{desired:desiredCount,running:runningCount,pending:pendingCount,status:status}'

      - name: Get recent logs
        run: |
          echo "üìã Getting last $LINES lines from $SERVICE logs..."
          aws logs tail "/ecs/ph-shoes-services-automation-$SERVICE" \
            --since 30m \
            --region $AWS_REGION \
            --format short \
            | tail -n $LINES

      - name: Check container health
        run: |
          echo "üè• Checking container health status..."
          TASK_ARN=$(aws ecs list-tasks \
            --cluster ph-shoes-services-ecs \
            --service-name ph-shoes-services-automation-$SERVICE \
            --query 'taskArns[0]' \
            --output text \
            --region $AWS_REGION)
          
          if [ "$TASK_ARN" != "None" ] && [ "$TASK_ARN" != "" ]; then
            aws ecs describe-tasks \
              --cluster ph-shoes-services-ecs \
              --tasks $TASK_ARN \
              --region $AWS_REGION \
              --query 'tasks[0].containers[0].{name:name,lastStatus:lastStatus,healthStatus:healthStatus,exitCode:exitCode}'
          else
            echo "‚ùå No running tasks found for $SERVICE"
          fi

      - name: Test service endpoint (backend services only)
        if: env.SERVICE != 'frontend'
        run: |
          echo "üåê Testing service endpoint..."
          SERVICE_URL="https://$SERVICE.phshoesproject.com/api/v1/system/status"
          echo "Testing: $SERVICE_URL"
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL || echo "000")
          echo "HTTP Status: $STATUS"
          
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Service is responding correctly"
            curl -s $SERVICE_URL | jq . || echo "Response is not JSON"
          else
            echo "‚ùå Service returned HTTP $STATUS"
            echo "Response body:"
            curl -s $SERVICE_URL || echo "Failed to get response"
          fi