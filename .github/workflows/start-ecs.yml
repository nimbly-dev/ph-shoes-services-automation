name: Start ECS Cluster (Baseline Capacity)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  start:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Set ASG baseline capacity
        run: |
          echo "Setting ASG baseline capacity..."
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ph-shoes-services-ecs-asg \
            --min-size 1 \
            --desired-capacity 3 \
            --region ap-southeast-1

      - name: Wait for EC2 instances to be ready
        run: |
          echo "Waiting for ASG instances to be InService and healthy..."
          for attempt in {1..30}; do
            INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names ph-shoes-services-ecs-asg \
              --region ap-southeast-1 \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text)

            if [ -z "$INSTANCE_IDS" ]; then
              echo "No InService instances yet (attempt $attempt/30)."
              sleep 20
              continue
            fi

            STATUS_SUMMARY=$(aws ec2 describe-instance-status \
              --instance-ids $INSTANCE_IDS \
              --region ap-southeast-1 \
              --query 'InstanceStatuses[*].{InstanceId:InstanceId,State:InstanceState.Name,Instance:InstanceStatus.Status,System:SystemStatus.Status}' \
              --output json)

            READY_COUNT=$(echo "$STATUS_SUMMARY" | jq '[.[] | select(.State=="running" and .Instance=="ok" and .System=="ok")] | length')

            if [ "$READY_COUNT" -ge 3 ]; then
              echo "EC2 instances are ready ($READY_COUNT/3). Workflow complete."
              exit 0
            fi

            echo "Instances not ready yet ($READY_COUNT/3) (attempt $attempt/30)."
            sleep 20
          done

          echo "Timed out waiting for EC2 instances to become ready."
          exit 1
