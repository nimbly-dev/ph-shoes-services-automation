name: Deploy Service to ECS

on:
  repository_dispatch:
    types: [deploy-service]
  workflow_dispatch:
    inputs:
      service:
        description: "Service name (frontend, user-accounts, catalog, etc.)"
        required: true
      image_uri:
        description: "Full ECR image URI"
        required: true
      container_port:
        description: "Container port (80 for frontend, 8080 for backend)"
        required: false
        default: '8080'
      desired_count:
        description: "Desired task count"
        required: false
        default: '1'

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-southeast-1
      SERVICE: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.service || github.event.inputs.service }}
      IMAGE_URI: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.image_uri || github.event.inputs.image_uri }}
      CONTAINER_PORT: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.container_port || github.event.inputs.container_port || '8080' }}
      DESIRED_COUNT: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.desired_count || github.event.inputs.desired_count || '1' }}
      APP_ENV: beta
      APP_VERSION: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.app_version || 'local' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform init
        working-directory: terraform-service-deploy
        run: |
          terraform init -input=false -reconfigure \
            -backend-config="key=services-tf-state/deployments/${SERVICE}.tfstate"

      - name: Set service-specific secrets
        id: secrets
        run: |
          case "$SERVICE" in
            frontend)
              echo "log_group=/ecs/ph-shoes-services-automation-frontend" >> $GITHUB_OUTPUT
              echo "exec_role=${{ secrets.FRONTEND_EXEC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "task_role=${{ secrets.FRONTEND_TASK_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "port=80" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "log_group=/ecs/ph-shoes-services-automation-$SERVICE" >> $GITHUB_OUTPUT
              echo "exec_role=${{ secrets.BACKEND_EXEC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "task_role=${{ secrets.BACKEND_TASK_ROLE_ARN }}" >> $GITHUB_OUTPUT
              echo "port=${CONTAINER_PORT}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Check if service exists
        id: check_service
        run: |
          STATUS=$(aws ecs describe-services \
            --cluster ph-shoes-services-ecs \
            --services ph-shoes-services-automation-${{ env.SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].status' \
            --output text 2>/dev/null || echo "MISSING")
          
          if [ "$STATUS" = "ACTIVE" ]; then
            echo "create_service=false" >> $GITHUB_OUTPUT
          else
            echo "create_service=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via Terraform
        working-directory: terraform-service-deploy
        env:
          TF_VAR_service_id: ${{ env.SERVICE }}
          TF_VAR_service_name: ph-shoes-services-automation-${{ env.SERVICE }}
          TF_VAR_container_image: ${{ env.IMAGE_URI }}
          TF_VAR_container_port: ${{ steps.secrets.outputs.port }}
          TF_VAR_desired_count: ${{ env.DESIRED_COUNT }}
          TF_VAR_log_group_name: ${{ steps.secrets.outputs.log_group }}
          TF_VAR_execution_role_arn: ${{ steps.secrets.outputs.exec_role }}
          TF_VAR_task_role_arn: ${{ steps.secrets.outputs.task_role }}
          TF_VAR_create_service: ${{ steps.check_service.outputs.create_service }}
          TF_VAR_environment: '{"APP_ENV":"${{ env.APP_ENV }}","APP_VERSION":"${{ env.APP_VERSION }}"}}'
        run: |
          echo "Deploying $SERVICE with image $IMAGE_URI on port $TF_VAR_container_port (create=$TF_VAR_create_service)"
          terraform apply -input=false -auto-approve

      - name: Wait for deployment health check
        run: |
          if [ "${{ env.SERVICE }}" = "frontend" ]; then
            echo "Checking ECS service status..."
            
            for i in {1..30}; do
              SERVICE_INFO=$(aws ecs describe-services \
                --cluster ph-shoes-services-ecs \
                --services ph-shoes-services-automation-frontend \
                --region ${{ env.AWS_REGION }} \
                --query 'services[0].{running:runningCount,desired:desiredCount,deployments:deployments[?status==`PRIMARY`].{status:status,rolloutState:rolloutState}}' --output json)
              
              RUNNING=$(echo $SERVICE_INFO | jq -r '.running')
              DESIRED=$(echo $SERVICE_INFO | jq -r '.desired')
              ROLLOUT_STATE=$(echo $SERVICE_INFO | jq -r '.deployments[0].rolloutState // "PENDING"')
              
              echo "ECS Status: $RUNNING/$DESIRED tasks running, Rollout: $ROLLOUT_STATE"
              
              if [ "$RUNNING" = "$DESIRED" ] && [ "$RUNNING" != "0" ] && [ "$ROLLOUT_STATE" = "COMPLETED" ]; then
                echo "✅ ECS tasks are running, checking URL health..."
                
                URL="https://phshoesproject.com"
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
                
                if [ "$STATUS" = "200" ]; then
                  echo "✅ Site is healthy (HTTP $STATUS)"
                  exit 0
                else
                  echo "URL returned HTTP $STATUS, waiting..."
                fi
              fi
              
              echo "Attempt $i/30 - waiting 30s..."
              sleep 30
            done
            
            echo "❌ Deployment failed - site not healthy after 15 minutes"
            exit 1
          else
            echo "Non-frontend service - showing status:"
            aws ecs describe-services \
              --cluster ph-shoes-services-ecs \
              --services ph-shoes-services-automation-${{ env.SERVICE }} \
              --region ${{ env.AWS_REGION }} \
              --query 'services[0].{desired:desiredCount,running:runningCount,pending:pendingCount}'
          fi
