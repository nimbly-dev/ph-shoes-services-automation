name: Auto DNS Update

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'DNS action to perform'
        required: true
        type: choice
        options: ['plan', 'apply', 'destroy']
        default: 'apply'
      dns_provider:
        description: 'DNS provider to use'
        required: true
        type: choice
        options: ['cloudflare', 'route53']
        default: 'cloudflare'
  repository_dispatch: # Allow triggering from other repositories
    types: [service-deployed, dns-update-needed, dns-update-required]
  schedule:
    - cron: '0 6 * * *' # Run daily at 6 AM UTC (2 PM Singapore time) to catch IP changes

jobs:
  dns-update:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Validate DNS provider configuration
        run: |
          DNS_PROVIDER="${{ github.event.inputs.dns_provider || 'cloudflare' }}"
          echo "ğŸ” Validating DNS provider: $DNS_PROVIDER"
          
          if [ "$DNS_PROVIDER" = "cloudflare" ]; then
            if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
              echo "âŒ Missing Cloudflare credentials for Cloudflare DNS"
              exit 1
            fi
            echo "âœ… Cloudflare credentials configured"
          else
            echo "âœ… Using Route53 DNS (AWS credentials already configured)"
          fi

      - name: Check ECS Service Status
        run: |
          echo "ğŸ” Checking ECS service status..."
          aws ecs describe-services \
            --cluster ph-shoes-services-ecs \
            --services \
              ph-shoes-services-automation-frontend \
              ph-shoes-services-automation-catalog \
              ph-shoes-services-automation-user-accounts \
              ph-shoes-services-automation-alerts \
              ph-shoes-services-automation-text-search \
            --query "services[*].{Name:serviceName,Running:runningCount,Desired:desiredCount}" \
            --output table

      - name: Check Current Instance IPs
        run: |
          echo "ğŸ“ Current instance distribution:"
          
          # Get container instances and their IPs
          CONTAINER_INSTANCES=$(aws ecs list-container-instances --cluster ph-shoes-services-ecs --query "containerInstanceArns[*]" --output text)
          if [ -n "$CONTAINER_INSTANCES" ]; then
            EC2_INSTANCES=$(aws ecs describe-container-instances \
              --cluster ph-shoes-services-ecs \
              --container-instances $CONTAINER_INSTANCES \
              --query "containerInstances[*].ec2InstanceId" \
              --output text)
            
            echo "ğŸ–¥ï¸  Instance IPs:"
            aws ec2 describe-instances \
              --instance-ids $EC2_INSTANCES \
              --query "Reservations[*].Instances[*].{InstanceId:InstanceId,PublicIP:PublicIpAddress,State:State.Name}" \
              --output table
          else
            echo "âŒ No container instances found - ECS cluster may be scaled down"
          fi
      
      - name: Skip DNS update when cluster is scaled to zero
        run: |
          INSTANCE_COUNT=$(aws ecs list-container-instances \
            --cluster ph-shoes-services-ecs \
            --query "length(containerInstanceArns)" \
            --output text)
          
          if [ "$INSTANCE_COUNT" = "0" ]; then
            echo "SKIP_DNS=true" >> $GITHUB_ENV
            echo "âš ï¸ No ECS instances running. Skipping DNS update for this run."
          else
            echo "SKIP_DNS=false" >> $GITHUB_ENV
          fi

      - name: Terraform Init
        if: env.SKIP_DNS != 'true'
        working-directory: terraform-dns
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init

      - name: Terraform Plan
        if: env.SKIP_DNS != 'true'
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "ğŸ“‹ Planning DNS changes..."
          terraform plan -detailed-exitcode
          PLAN_EXIT_CODE=$?
          
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "âœ… No changes needed"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "ğŸ“ Changes detected and planned"
          else
            echo "âŒ Terraform plan failed"
            exit $PLAN_EXIT_CODE
          fi

      - name: Terraform Apply
        if: env.SKIP_DNS != 'true' && (github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule')
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "ğŸš€ Applying DNS changes..."
          terraform apply -auto-approve
          echo "âœ… DNS changes applied successfully"

      - name: Terraform Destroy
        if: env.SKIP_DNS != 'true' && github.event.inputs.action == 'destroy'
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "ğŸ—‘ï¸  Destroying DNS records..."
          terraform destroy -auto-approve
          echo "âœ… DNS records destroyed"

      - name: Test DNS Resolution
        if: env.SKIP_DNS != 'true' && (github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule')
        run: |
          echo "ğŸŒ Testing DNS resolution after changes..."
          
          # Wait for DNS propagation
          echo "â³ Waiting 30 seconds for DNS propagation..."
          sleep 30
          
          # Test main domain
          echo "Testing phshoesproject.com..."
          if nslookup phshoesproject.com; then
            echo "âœ… Main domain resolves"
          else
            echo "âŒ Main domain resolution failed"
          fi
          
          # Test subdomains
          for subdomain in catalog accounts alerts text-search; do
            echo "Testing ${subdomain}.phshoesproject.com..."
            if nslookup ${subdomain}.phshoesproject.com; then
              echo "âœ… ${subdomain} subdomain resolves"
            else
              echo "âŒ ${subdomain} subdomain resolution failed"
            fi
          done

      - name: Test Service Endpoints
        if: env.SKIP_DNS != 'true' && (github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule')
        continue-on-error: true  # Allow workflow to continue even if services return errors
        run: |
          echo "ğŸ” Testing service endpoints after DNS update..."
          echo "âš ï¸  Note: This step may show warnings for services still starting up"
          
          # Wait a bit more for DNS propagation
          sleep 10
          
          # Test all services with better error handling
          echo "Testing frontend..."
          if response=$(curl -I -s --max-time 10 https://phshoesproject.com 2>&1); then
            status=$(echo "$response" | head -1)
            echo "$status"
            if echo "$status" | grep -q "200\|301\|302"; then
              echo "âœ… Frontend responding"
            else
              echo "âš ï¸  Frontend returned: $status"
            fi
          else
            echo "âš ï¸  Frontend connection failed"
          fi
          
          echo "Testing user accounts..."
          if response=$(curl -I -s --max-time 10 https://accounts.phshoesproject.com/api/v1/system/status 2>&1); then
            status=$(echo "$response" | head -1)
            echo "$status"
            if echo "$status" | grep -q "200\|301\|302"; then
              echo "âœ… User accounts responding"
            else
              echo "âš ï¸  User accounts returned: $status (may need nginx restart)"
            fi
          else
            echo "âš ï¸  User accounts connection failed"
          fi
          
          echo "Testing catalog..."
          if response=$(curl -I -s --max-time 10 https://catalog.phshoesproject.com/api/v1/system/status 2>&1); then
            status=$(echo "$response" | head -1)
            echo "$status"
            if echo "$status" | grep -q "200\|301\|302"; then
              echo "âœ… Catalog responding"
            else
              echo "âš ï¸  Catalog returned: $status (may need nginx restart)"
            fi
          else
            echo "âš ï¸  Catalog connection failed"
          fi
          
          echo "Testing alerts..."
          if response=$(curl -I -s --max-time 10 https://alerts.phshoesproject.com/api/v1/system/status 2>&1); then
            status=$(echo "$response" | head -1)
            echo "$status"
            if echo "$status" | grep -q "200\|301\|302"; then
              echo "âœ… Alerts responding"
            else
              echo "âš ï¸  Alerts returned: $status (may need nginx restart)"
            fi
          else
            echo "âš ï¸  Alerts connection failed"
          fi
          
          echo "Testing text-search..."
          if response=$(curl -I -s --max-time 10 https://text-search.phshoesproject.com/api/v1/system/status 2>&1); then
            status=$(echo "$response" | head -1)
            echo "$status"
            if echo "$status" | grep -q "200\|301\|302"; then
              echo "âœ… Text-search responding"
            else
              echo "âš ï¸  Text-search returned: $status (may need nginx restart)"
            fi
          else
            echo "âš ï¸  Text-search connection failed"
          fi
          
          echo ""
          echo "ğŸ“‹ Summary: DNS routing is working! Any 502 errors indicate nginx needs restart on those instances."

      - name: Log deployment trigger information
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸ”„ DNS update triggered by service deployment"
          echo "Event Type: ${{ github.event.action }}"
          echo "Service: ${{ github.event.client_payload.service_name || 'unknown' }}"
          echo "Trigger: ${{ github.event.client_payload.trigger || 'unknown' }}"
          echo "Deployment Timestamp: ${{ github.event.client_payload.deployment_timestamp || 'N/A' }}"
          echo "Health Check Passed: ${{ github.event.client_payload.health_check_passed || 'N/A' }}"
          echo "Image URI: ${{ github.event.client_payload.image_uri || 'N/A' }}"
          echo "App Version: ${{ github.event.client_payload.app_version || 'N/A' }}"
          echo "Triggered By: ${{ github.event.client_payload.triggered_by || 'N/A' }}"
          echo "Workflow Run ID: ${{ github.event.client_payload.workflow_run_id || 'N/A' }}"
          echo ""
          echo "âœ… DNS update workflow has been triggered"
