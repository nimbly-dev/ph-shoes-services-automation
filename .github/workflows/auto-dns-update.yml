name: Auto DNS Update

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'DNS action to perform'
        required: true
        type: choice
        options: ['plan', 'apply', 'destroy']
        default: 'apply'
      dns_provider:
        description: 'DNS provider to use'
        required: true
        type: choice
        options: ['cloudflare', 'route53']
        default: 'cloudflare'
  repository_dispatch: # Allow triggering from other repositories
    types: [service-deployed, dns-update-needed, dns-update-required]
  schedule:
    - cron: '0 6 * * *' # Run daily at 6 AM UTC (2 PM Singapore time) to catch IP changes

jobs:
  dns-update:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Validate DNS provider configuration
        run: |
          DNS_PROVIDER="${{ github.event.inputs.dns_provider || 'cloudflare' }}"
          echo "üîç Validating DNS provider: $DNS_PROVIDER"
          
          if [ "$DNS_PROVIDER" = "cloudflare" ]; then
            if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
              echo "‚ùå Missing Cloudflare credentials for Cloudflare DNS"
              exit 1
            fi
            echo "‚úÖ Cloudflare credentials configured"
          else
            echo "‚úÖ Using Route53 DNS (AWS credentials already configured)"
          fi

      - name: Check ECS Service Status
        run: |
          echo "üîç Checking ECS service status..."
          aws ecs describe-services \
            --cluster ph-shoes-services-ecs \
            --services \
              ph-shoes-services-automation-frontend \
              ph-shoes-services-automation-catalog \
              ph-shoes-services-automation-user-accounts \
              ph-shoes-services-automation-alerts \
              ph-shoes-services-automation-text-search \
            --query "services[*].{Name:serviceName,Running:runningCount,Desired:desiredCount}" \
            --output table

      - name: Check Current Instance IPs
        run: |
          echo "üìç Current instance distribution:"
          
          # Get container instances and their IPs
          CONTAINER_INSTANCES=$(aws ecs list-container-instances --cluster ph-shoes-services-ecs --query "containerInstanceArns[*]" --output text)
          if [ -n "$CONTAINER_INSTANCES" ]; then
            EC2_INSTANCES=$(aws ecs describe-container-instances \
              --cluster ph-shoes-services-ecs \
              --container-instances $CONTAINER_INSTANCES \
              --query "containerInstances[*].ec2InstanceId" \
              --output text)
            
            echo "üñ•Ô∏è  Instance IPs:"
            aws ec2 describe-instances \
              --instance-ids $EC2_INSTANCES \
              --query "Reservations[*].Instances[*].{InstanceId:InstanceId,PublicIP:PublicIpAddress,State:State.Name}" \
              --output table
          else
            echo "‚ùå No container instances found - ECS cluster may be scaled down"
          fi

      - name: Terraform Init
        working-directory: terraform-dns
        run: |
          echo "üîß Initializing Terraform..."
          terraform init

      - name: Terraform Plan
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "üìã Planning DNS changes..."
          terraform plan -detailed-exitcode
          PLAN_EXIT_CODE=$?
          
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No changes needed"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "üìù Changes detected and planned"
          else
            echo "‚ùå Terraform plan failed"
            exit $PLAN_EXIT_CODE
          fi

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule'
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "üöÄ Applying DNS changes..."
          terraform apply -auto-approve
          echo "‚úÖ DNS changes applied successfully"

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: terraform-dns
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_use_cloudflare_dns: ${{ github.event.inputs.dns_provider == 'cloudflare' || github.event.inputs.dns_provider == '' }}
        run: |
          echo "üóëÔ∏è  Destroying DNS records..."
          terraform destroy -auto-approve
          echo "‚úÖ DNS records destroyed"

      - name: Test DNS Resolution
        if: github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule'
        run: |
          echo "üåê Testing DNS resolution after changes..."
          
          # Wait for DNS propagation
          echo "‚è≥ Waiting 30 seconds for DNS propagation..."
          sleep 30
          
          # Test main domain
          echo "Testing phshoesproject.com..."
          if nslookup phshoesproject.com; then
            echo "‚úÖ Main domain resolves"
          else
            echo "‚ùå Main domain resolution failed"
          fi
          
          # Test subdomains
          for subdomain in catalog accounts alerts text-search; do
            echo "Testing ${subdomain}.phshoesproject.com..."
            if nslookup ${subdomain}.phshoesproject.com; then
              echo "‚úÖ ${subdomain} subdomain resolves"
            else
              echo "‚ùå ${subdomain} subdomain resolution failed"
            fi
          done

      - name: Test Service Endpoints
        if: github.event.inputs.action == 'apply' || github.event.inputs.action == '' || github.event_name == 'repository_dispatch' || github.event_name == 'schedule'
        run: |
          echo "üîç Testing service endpoints after DNS update..."
          
          # Wait a bit more for DNS propagation
          sleep 10
          
          # Test all services
          echo "Testing frontend..."
          if curl -I -s --max-time 10 https://phshoesproject.com | head -1; then
            echo "‚úÖ Frontend responding"
          else
            echo "‚ùå Frontend not responding"
          fi
          
          echo "Testing user accounts..."
          if curl -I -s --max-time 10 https://accounts.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ User accounts responding"
          else
            echo "‚ùå User accounts not responding"
          fi
          
          echo "Testing catalog..."
          if curl -I -s --max-time 10 https://catalog.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Catalog responding"
          else
            echo "‚ùå Catalog not responding"
          fi
          
          echo "Testing alerts..."
          if curl -I -s --max-time 10 https://alerts.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Alerts responding"
          else
            echo "‚ùå Alerts not responding"
          fi
          
          echo "Testing text-search..."
          if curl -I -s --max-time 10 https://text-search.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Text-search responding"
          else
            echo "‚ùå Text-search not responding"
          fi

      - name: Log deployment trigger information
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "üîÑ DNS update triggered by service deployment"
          echo "Event Type: ${{ github.event.action }}"
          echo "Service: ${{ github.event.client_payload.service_name || 'unknown' }}"
          echo "Trigger: ${{ github.event.client_payload.trigger || 'unknown' }}"
          echo "Deployment Timestamp: ${{ github.event.client_payload.deployment_timestamp || 'N/A' }}"
          echo "Health Check Passed: ${{ github.event.client_payload.health_check_passed || 'N/A' }}"
          echo "Image URI: ${{ github.event.client_payload.image_uri || 'N/A' }}"
          echo "App Version: ${{ github.event.client_payload.app_version || 'N/A' }}"
          echo "Triggered By: ${{ github.event.client_payload.triggered_by || 'N/A' }}"
          echo "Workflow Run ID: ${{ github.event.client_payload.workflow_run_id || 'N/A' }}"
          echo ""
          echo "‚úÖ DNS update workflow has been triggered"