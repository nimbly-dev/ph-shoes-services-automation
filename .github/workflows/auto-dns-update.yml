name: Auto DNS Update

on:
  workflow_dispatch: # Allow manual trigger
  repository_dispatch: # Allow triggering from other repositories
    types: [service-deployed, dns-update-needed, dns-update-required]
  schedule:
    - cron: '0 6 * * *' # Run daily at 6 AM UTC (2 PM Singapore time) to catch IP changes

jobs:
  update-dns:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Validate Cloudflare credentials
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
            echo "‚ùå Missing Cloudflare credentials"
            exit 1
          fi
          echo "‚úÖ Cloudflare credentials configured"

      - name: Check ECS Service Status
        run: |
          echo "üîç Checking ECS service status..."
          aws ecs describe-services \
            --cluster ph-shoes-application-services-ecs \
            --services \
              ph-shoes-application-services-frontend \
              ph-shoes-application-services-catalog \
              ph-shoes-application-services-user-accounts \
              ph-shoes-application-services-alerts \
            --query "services[*].{Name:serviceName,Running:runningCount,Desired:desiredCount}" \
            --output table

      - name: Check Current Instance IPs
        run: |
          echo "üìç Current instance distribution:"
          
          # Get tasks and their instances
          TASKS=$(aws ecs list-tasks --cluster ph-shoes-application-services-ecs --query "taskArns[*]" --output text)
          if [ -n "$TASKS" ]; then
            aws ecs describe-tasks \
              --cluster ph-shoes-application-services-ecs \
              --tasks $TASKS \
              --query "tasks[*].{Service:group,Instance:containerInstanceArn}" \
              --output table
            
            # Get container instances and their IPs
            CONTAINER_INSTANCES=$(aws ecs list-container-instances --cluster ph-shoes-application-services-ecs --query "containerInstanceArns[*]" --output text)
            if [ -n "$CONTAINER_INSTANCES" ]; then
              EC2_INSTANCES=$(aws ecs describe-container-instances \
                --cluster ph-shoes-application-services-ecs \
                --container-instances $CONTAINER_INSTANCES \
                --query "containerInstances[*].ec2InstanceId" \
                --output text)
              
              echo "üñ•Ô∏è  Instance IPs:"
              aws ec2 describe-instances \
                --instance-ids $EC2_INSTANCES \
                --query "Reservations[*].Instances[*].{InstanceId:InstanceId,PublicIP:PublicIpAddress,State:State.Name}" \
                --output table
            fi
          else
            echo "‚ùå No tasks found - services may be scaled down"
          fi

      - name: Apply DNS updates
        working-directory: terraform-core
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          terraform init
          echo "üöÄ Applying DNS updates..."
          terraform apply -auto-approve
          echo "‚úÖ DNS updates completed"

      - name: Test Service Endpoints
        run: |
          echo "üåê Testing service endpoints after DNS update..."
          
          # Wait a moment for DNS propagation
          sleep 10
          
          # If triggered by deployment, prioritize testing the deployed service
          DEPLOYED_SERVICE="${{ github.event.client_payload.service_name || '' }}"
          if [ -n "$DEPLOYED_SERVICE" ]; then
            echo "üéØ Prioritizing validation of deployed service: $DEPLOYED_SERVICE"
            
            case "$DEPLOYED_SERVICE" in
              frontend)
                echo "Testing deployed frontend service..."
                if curl -I -s --max-time 15 https://phshoesproject.com | head -1; then
                  echo "‚úÖ Deployed frontend service responding"
                else
                  echo "‚ùå Deployed frontend service not responding"
                fi
                ;;
              user-accounts)
                echo "Testing deployed user-accounts service..."
                if curl -I -s --max-time 15 https://accounts.phshoesproject.com/system/status | head -1; then
                  echo "‚úÖ Deployed user-accounts service responding"
                else
                  echo "‚ùå Deployed user-accounts service not responding"
                fi
                ;;
              catalog)
                echo "Testing deployed catalog service..."
                if curl -I -s --max-time 15 https://catalog.phshoesproject.com/system/status | head -1; then
                  echo "‚úÖ Deployed catalog service responding"
                else
                  echo "‚ùå Deployed catalog service not responding"
                fi
                ;;
              alerts)
                echo "Testing deployed alerts service..."
                if curl -I -s --max-time 15 https://alerts.phshoesproject.com/system/status | head -1; then
                  echo "‚úÖ Deployed alerts service responding"
                else
                  echo "‚ùå Deployed alerts service not responding"
                fi
                ;;
              text-search)
                echo "Testing deployed text-search service..."
                if curl -I -s --max-time 15 https://text-search.phshoesproject.com/system/status | head -1; then
                  echo "‚úÖ Deployed text-search service responding"
                else
                  echo "‚ùå Deployed text-search service not responding"
                fi
                ;;
            esac
            echo ""
          fi
          
          # Test all services for comprehensive validation
          echo "üîç Testing all service endpoints..."
          
          # Test frontend
          echo "Testing frontend..."
          if curl -I -s --max-time 10 https://phshoesproject.com | head -1; then
            echo "‚úÖ Frontend responding"
          else
            echo "‚ùå Frontend not responding"
          fi
          
          # Test user accounts
          echo "Testing user accounts..."
          if curl -I -s --max-time 10 https://accounts.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ User accounts responding"
          else
            echo "‚ùå User accounts not responding"
          fi
          
          # Test catalog
          echo "Testing catalog..."
          if curl -I -s --max-time 10 https://catalog.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Catalog responding"
          else
            echo "‚ùå Catalog not responding"
          fi
          
          # Test alerts
          echo "Testing alerts..."
          if curl -I -s --max-time 10 https://alerts.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Alerts responding"
          else
            echo "‚ùå Alerts not responding"
          fi
          
          # Test text-search
          echo "Testing text-search..."
          if curl -I -s --max-time 10 https://text-search.phshoesproject.com/system/status | head -1; then
            echo "‚úÖ Text-search responding"
          else
            echo "‚ùå Text-search not responding"
          fi

      - name: Log deployment trigger information
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "üîÑ DNS update triggered by service deployment"
          echo "Event Type: ${{ github.event.action }}"
          echo "Service: ${{ github.event.client_payload.service_name || 'unknown' }}"
          echo "Trigger: ${{ github.event.client_payload.trigger || 'unknown' }}"
          echo "Deployment Timestamp: ${{ github.event.client_payload.deployment_timestamp || 'N/A' }}"
          echo "Health Check Passed: ${{ github.event.client_payload.health_check_passed || 'N/A' }}"
          echo "Image URI: ${{ github.event.client_payload.image_uri || 'N/A' }}"
          echo "App Version: ${{ github.event.client_payload.app_version || 'N/A' }}"
          echo "Triggered By: ${{ github.event.client_payload.triggered_by || 'N/A' }}"
          echo "Workflow Run ID: ${{ github.event.client_payload.workflow_run_id || 'N/A' }}"
          echo ""
          echo "‚úÖ DNS update will now refresh routing for the deployed service"