name: Auto DNS Update

on:
  workflow_dispatch: # Allow manual trigger
  repository_dispatch:
    types: [update-dns] # Triggered by deploy-service workflow

jobs:
  update-dns:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Set Terraform variables
        working-directory: terraform-core
        run: |
          echo "TF_VAR_cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}" >> $GITHUB_ENV
          
      - name: Debug Cloudflare credentials
        run: |
          echo "Checking if Cloudflare secrets are set..."
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "❌ CLOUDFLARE_API_TOKEN is empty or not set"
          else
            echo "✅ CLOUDFLARE_API_TOKEN is set (length: ${#CLOUDFLARE_API_TOKEN})"
            echo "Token starts with: ${CLOUDFLARE_API_TOKEN:0:8}..."
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ZONE_ID }}" ]; then
            echo "❌ CLOUDFLARE_ZONE_ID is empty or not set"
          else
            echo "✅ CLOUDFLARE_ZONE_ID is set: ${{ secrets.CLOUDFLARE_ZONE_ID }}"
          fi
          
          # Test the API token
          echo "Testing Cloudflare API token..."
          curl -s "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Check for infrastructure changes
        id: plan
        working-directory: terraform-core
        run: |
          terraform init
          set +e
          terraform plan -detailed-exitcode -out=tfplan
          EXIT_CODE=$?
          set -e
          echo "changes=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "Terraform plan exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 1 ]; then
            echo "Terraform plan failed"
            exit 1
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "Changes detected - will apply"
          else
            echo "No changes detected"
          fi

      - name: Debug output
        run: |
          echo "Plan output: '${{ steps.plan.outputs.changes }}'"
          echo "Type check: ${{ steps.plan.outputs.changes == '2' }}"

      - name: Apply DNS updates if needed
        if: steps.plan.outputs.changes == '2'
        working-directory: terraform-core
        run: |
          echo "Infrastructure changes detected, applying updates..."
          terraform apply -auto-approve tfplan

      - name: Force apply if changes detected in plan output
        if: steps.plan.outputs.changes == '0'
        working-directory: terraform-core
        run: |
          # Check if the plan file contains actual changes
          if terraform show tfplan | grep -q "Plan:.*to add.*to change.*to destroy"; then
            echo "Plan contains changes despite exit code 0, applying anyway..."
            terraform apply -auto-approve tfplan
          else
            echo "No infrastructure changes detected"
          fi