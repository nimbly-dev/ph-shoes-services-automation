name: Deploy Service to ECS

on:
  repository_dispatch:
    types: [deploy-service]
  workflow_dispatch:
    inputs:
      service:
        description: "Service name (frontend, user-accounts, etc.)"
        required: true
      image_uri:
        description: "Full ECR image URI"
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-southeast-1
      SERVICE: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.service || github.event.inputs.service }}
      IMAGE_URI: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.image_uri || github.event.inputs.image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform init
        working-directory: terraform-service-deploy
        run: terraform init -input=false -reconfigure

      - name: Deploy via Terraform
        working-directory: terraform-service-deploy
        env:
          TF_VAR_container_image: ${{ env.IMAGE_URI }}
          TF_VAR_log_group_name: ${{ secrets.FRONTEND_LOG_GROUP_NAME }}
          TF_VAR_execution_role_arn: ${{ secrets.FRONTEND_EXEC_ROLE_ARN }}
          TF_VAR_task_role_arn: ${{ secrets.FRONTEND_TASK_ROLE_ARN }}
          TF_VAR_target_group_arn: ${{ secrets.FRONTEND_TARGET_GROUP_ARN }}
        run: |
          echo "Deploying service '$SERVICE' with image '$IMAGE_URI'"
          case "$SERVICE" in
            frontend)
              terraform apply -input=false -auto-approve \
                -var "service_id=frontend" \
                -var "desired_count=1"
              ;;
            *)
              echo "Unknown service '$SERVICE'" >&2
              exit 1
              ;;
          esac
