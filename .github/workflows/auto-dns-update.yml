name: Auto DNS Update

on:
  workflow_dispatch: # Allow manual trigger
  repository_dispatch:
    types: [update-dns] # Triggered by deploy-service workflow

jobs:
  update-dns:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Set Terraform variables
        working-directory: terraform-core
        run: |
          echo "TF_VAR_cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV
          echo "TF_VAR_cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}" >> $GITHUB_ENV

      - name: Check for infrastructure changes
        id: plan
        working-directory: terraform-core
        run: |
          terraform init
          terraform plan -detailed-exitcode -out=tfplan
          echo "changes=$?" >> $GITHUB_OUTPUT

      - name: Apply DNS updates if needed
        if: steps.plan.outputs.changes == '2'
        working-directory: terraform-core
        run: |
          echo "Infrastructure changes detected, applying updates..."
          terraform apply -auto-approve tfplan

      - name: No changes needed
        if: steps.plan.outputs.changes == '0'
        run: echo "No infrastructure changes detected"